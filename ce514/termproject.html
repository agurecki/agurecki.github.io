<html>
<head>
  <title>Great Blue Heron Sighting Predictor</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
      <!-- Link to external Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
      <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-omnivore@0.3.4/leaflet-omnivore.min.js"></script> 
  <link rel="stylesheet" href="../style.css">  

<style>
        #map {
            height: 600px;
        }
        #forecast-container {
            display: none;
            width: 100%;
            height: 400px;
        }
        canvas {
            width: 100% !important;
            height: 100% !important;
        }
    </style>
</head>

  
<body>
    <header>
        <h1>Amber Allen</h1>
      <h2>A9 - NWM Forcast Application</h2>
        <p>CE 514 | Winter 2025 | February 20, 2025</p>
    </header>

    <div class="container">
        <section>
  <h1>Great Blue Heron Sighting Forecaster</h1>
  <h2>About the Creator</h2>
          <p>Amber Allen is a Ph.D. student in Civil Engineering at Brigham Young University, specializing in transportation emissions and air quality. 
  She is currently enrolled in CE 514 â€“ Geospatial Software Development, a graduate-level course that explores various tools for creating 
  and analyzing geospatial data. The course integrates coding languages such as HTML, CSS, and JavaScript to enhance technical proficiency
  and effectively communicate geospatial concepts. This website is an application of what has been learned during the first unit of study, 
  including Leaflet, KML, and the National Water Model. </p> <br>

          <h2>About the Data</h2>       
<p>
  The <strong>National Water Model (NWM)</strong> is a high-resolution hydrologic modeling system that provides 
  real-time and forecasted streamflow predictions for over <strong>2.7 million stream reaches</strong> across the United States. 
  Using the <strong>National Hydrography Dataset (NHDPlus)</strong>, the model simulates detailed river networks to support 
  water resource planning and emergency response.
</p>

<p>
  The NWM offers multiple forecast scenarios, including <strong>short-range (up to 18 hours), medium-range (10 days), 
  and long-range (30 days) predictions</strong>, along with retrospective analyses for trend studies. By incorporating 
  real-time observations from <strong>stream gauges, radar, and satellite data</strong>, the model improves accuracy and 
  reliability in monitoring <strong>floods, droughts, and changing hydrologic conditions</strong>.
</p>

<p>
  While the NWM is a valuable tool for <strong>water resource managers, emergency responders, and researchers</strong>, 
  it is essential to recognize that forecasts are subject to <strong>uncertainties due to weather variability, data 
  limitations, and model assumptions</strong>. Users should interpret the data carefully and supplement it with 
  local knowledge and official flood warnings when making critical decisions.
</p>

          </section>
    </div>

      <div class="container">
        <section>
  <h2>Resources</h2>
  <p>Learn more about the NWM:</p>
  <ul>
    <li><a href="https://water.noaa.gov/about/nwm">NOAA NWM Homepage</a></li>
    <li><a href="howitworks.html">How This Web App Works</a></li>
  </ul>
        </section>
      </div>
<div id="map"></div>

<div id="forecast-container">
    <canvas id="streamflowChart"></canvas>
</div>

    <script>
    // Initialize the map
    var map = L.map('map').setView([42.3601, -71.0589], 9); // Center on the MASS

    // Add a tile layer (OpenStreetMap)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // Load KML file (replace with your actual file URL)
    var kmlLayer = omnivore.kml('https://raw.githubusercontent.com/agurecki/agurecki.github.io/refs/heads/main/ce514/watersheds2.kml')
        .on('ready', function() {
            map.fitBounds(kmlLayer.getBounds()); // Fit map to KML bounds

            // Iterate over each feature in the KML layer
            kmlLayer.eachLayer(function(layer) {
                if (layer.feature && layer.feature.properties) {
                    var name = layer.feature.properties.name || "Unknown State";
                    var desc = layer.feature.properties.description || "No description available";
                    
                    // Bind popup with state name and description
                    layer.bindPopup("<b>" + name + "</b><br>" + desc);
                }
            });
        })
        .addTo(map);
          var kmlLayer = omnivore.kml('https://raw.githubusercontent.com/agurecki/agurecki.github.io/refs/heads/main/ce514/Major_Rivers_and_Streams.kml')
        .on('ready', function() {
            map.fitBounds(kmlLayer.getBounds()); // Fit map to KML bounds

            // Iterate over each feature in the KML layer
            kmlLayer.eachLayer(function(layer) {
                if (layer.feature && layer.feature.properties) {
                    var name = layer.feature.properties.name || "Unknown State";
                    var desc = layer.feature.properties.description || "No description available";
                    
                    // Bind popup with state name and description
                    layer.bindPopup("<b>" + name + "</b><br>" + desc);
                }
            });
        })
        .addTo(map);
// River data with corresponding reach IDs
    var rivers = [
        { name: "Merrimack River at Lowell", coords: [42.7153, -71.5148], reachID: "6746184" },
        { name: "Squannacook River at West Groton", coords: [42.5940, -71.6505], reachID: "6076039" },
        { name: "Concord River at Lowell", coords: [42.4456, -71.3522], reachID: "6771379" },
        { name: "Merrimack River at Goffs Falls", coords: [42.8251, -71.5151], reachID: "6745688" },
        { name: "Merrimack River at Nashua", coords: [42.7651, -71.4682], reachID: "6746036" },
        { name: "Shawsheen River at Andover", coords: [42.6460, -71.2579], reachID: "6744972" },
        { name: "Charles River at Dover", coords: [42.3477, -71.4211], reachID: "5867435" },
        { name: "Neponset River at Norwood", coords: [42.2578, -71.1215], reachID: "5867537" },
        { name: "Sudbury River at Saxonville", coords: [42.2570, -71.4723], reachID: "6772927" }
    ];

    // Add markers to the map for each river and bind the forecast buttons
    rivers.forEach(function(river) {
        var marker = L.marker(river.coords).addTo(map);

        marker.bindPopup(
            `<strong>${river.name}</strong><br>` +
<!-- Merrimack River at Lowell -->
<button onclick="getForecast('short_range', 6746184, 'Merrimack River at Lowell')">Short-Range Forecast - Merrimack River at Lowell</button>
<button onclick="getForecast('medium_range', 6746184, 'Merrimack River at Lowell')">Medium-Range Forecast - Merrimack River at Lowell</button>
<button onclick="getForecast('long_range', 6746184, 'Merrimack River at Lowell')">Long-Range Forecast - Merrimack River at Lowell</button>

<!-- Concord River at Lowell -->
<button onclick="getForecast('short_range', 6771379, 'Concord River at Lowell')">Short-Range Forecast - Concord River at Lowell</button>
<button onclick="getForecast('medium_range', 6771379, 'Concord River at Lowell')">Medium-Range Forecast - Concord River at Lowell</button>
<button onclick="getForecast('long_range', 6771379, 'Concord River at Lowell')">Long-Range Forecast - Concord River at Lowell</button>

      
        );
    });

   async function getForecast(forecastType, reachID, riverName) {
    const forecastContainer = document.getElementById('forecast-container');
    forecastContainer.style.display = 'block';

    const apiUrl = `https://api.water.noaa.gov/nwps/v1/reaches/${reachID}/streamflow?series=${forecastType}`;
    try {
        const response = await fetch(apiUrl);
        if (!response.ok) {
            throw new Error(`HTTP error status: ${response.status} - ${response.statusText}`);
        }

        const json_data = await response.json();

        // Log the full response to the console for debugging
        console.log("API Response:", json_data);

        // Check if the forecast data exists for the specific forecastType
        if (!json_data[forecastType] || !json_data[forecastType].series || !json_data[forecastType].series.data || json_data[forecastType].series.data.length === 0) {
            throw new Error(`No forecast data available for ${forecastType} on ${riverName}.`);
        }

        const streamflowData = json_data[forecastType].series.data;
        const timestamps = streamflowData.map(item => item.validTime);
        const flowValues = streamflowData.map(item => item.flow);

        // Create the chart
        const ctx = document.getElementById('streamflowChart').getContext('2d');
        let chart = Chart.getChart('streamflowChart'); // Check if chart exists

        if (chart) {
            chart.destroy(); // Destroy existing chart if present
        }

        chart = new Chart(ctx, {
            type: "line",
            data: {
                labels: timestamps,
                datasets: [{
                    label: `Streamflow Forecast (${forecastType.replace('_', ' ').toUpperCase()})`,
                    data: flowValues,
                    borderColor: "#0077b6",
                    borderWidth: 3,
                    fill: true,
                    backgroundColor: createGradient(ctx),
                    tension: 0.4,
                    pointBackgroundColor: "#ffcc00",
                    pointBorderColor: "#005f99",
                    pointRadius: 5,
                    pointHoverRadius: 8,
                    pointHoverBackgroundColor: "#ff5733",
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { labels: { color: "#333" } },
                    tooltip: { backgroundColor: "rgba(0, 0, 0, 0.8)" }
                },
                scales: {
                    x: {
                        ticks: { color: "#005f99", font: { size: 14 } },
                        grid: { color: "rgba(0, 0, 0, 0.1)" },
                        title: { display: true, text: "Time", color: "#222" }
                    },
                    y: {
                        ticks: { color: "#005f99", font: { size: 14 } },
                        grid: { color: "rgba(0, 0, 0, 0.1)" },
                        title: { display: true, text: "Streamflow (cfs)", color: "#222" }
                    }
                },
            }
        });
    } catch (error) {
        console.error(error);
        alert(error.message);
    }
}

</script>

  <div id="container">
    <section>
    <h2>How It Works</h2>
    <p>
        The streamflow forecast tool retrieves and displays forecasted water flow data based on a user-provided 
        <strong>Reach ID</strong>. Here's how it works:
    </p>

    <h3>1. User Input</h3>
    <p>
        The user enters a Reach ID into the input field and clicks the "Get Forecast" button. If no ID is entered, 
        an alert prompts the user to provide one.
    </p>

    <h3>2. Fetching Forecast Data</h3>
    <p>
        The tool sends a request to the <a href="https://api.water.noaa.gov/nwps/v1" target="_blank">NOAA NWPS API</a> 
        using the entered Reach ID. If the API responds successfully, the streamflow forecast data is retrieved.
        If no data is available, an error message is displayed.
    </p>

    <h3>3. Displaying the Data</h3>
    <p>
        The forecast section appears, and the retrieved data is processed into two key components:
    </p>
    <ul>
        <li><strong>A Table:</strong> Displays time-stamped streamflow values.</li>
        <li><strong>A Chart:</strong> A visually appealing line graph showing streamflow trends over time.</li>
    </ul>

    <h3>4. Chart Features</h3>
    <p>
        The chart uses <a href="https://www.chartjs.org/" target="_blank">Chart.js</a> and includes:
    </p>
    <ul>
        <li>Smooth curved lines for better readability.</li>
        <li>A blue gradient background representing water flow.</li>
        <li>Interactive hover effects for precise data points.</li>
        <li>Custom-styled axis labels and tooltips.</li>
    </ul>

    <h3>5. Error Handling</h3>
    <p>
        If something goes wrong (e.g., an invalid Reach ID or network issues), the tool:
    </p>
    <ul>
        <li>Displays an error message.</li>
        <li>Clears any previously displayed data to prevent confusion.</li>
    </ul>

    <h3>Final Result</h3>
    <p>
        This tool automates the process of retrieving, formatting, and presenting streamflow forecast data, 
        making it easy to analyze water flow trends in real time! ðŸš€
    </p>
  </div>

<script>
  document.querySelectorAll('a').forEach(link => {
    link.setAttribute('target', '_blank');
    link.setAttribute('rel', 'noopener noreferrer');
  });
</script>

</html>
